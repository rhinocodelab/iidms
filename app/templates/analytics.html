{% extends "base.html" %}

{% block title %}Analytics Dashboard - IDMS{% endblock %}

{% block page_title %}Analytics Dashboard{% endblock %}
{% block page_subtitle %}Comprehensive insights and performance metrics{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Export Analytics Button -->
    <div class="flex justify-end">
        <button onclick="exportAnalytics()" class="bg-red-600 text-white px-4 py-2 hover:bg-red-700 transition-colors flex items-center">
            <i class="fas fa-file-pdf mr-2"></i>
            Export Analytics
        </button>
    </div>
    
    <!-- KPI Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-white  shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="bg-blue-100 p-3 rounded-lg">
                    <i class="fas fa-file-alt text-xl text-blue-600"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Total Documents</p>
                    <p class="text-2xl font-semibold text-gray-900" id="total-documents">--</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white  shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="bg-green-100 p-3 rounded-lg">
                    <i class="fas fa-check-circle text-xl text-green-600"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Processed Today</p>
                    <p class="text-2xl font-semibold text-gray-900" id="processed-today">--</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white  shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="bg-purple-100 p-3 rounded-lg">
                    <i class="fas fa-clock text-xl text-purple-600"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Avg Processing Time</p>
                    <p class="text-2xl font-semibold text-gray-900" id="avg-processing-time">--</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white  shadow-sm border border-gray-200 p-6">
            <div class="flex items-center">
                <div class="bg-orange-100 p-3 rounded-lg">
                    <i class="fas fa-exclamation-triangle text-xl text-orange-600"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Error Rate</p>
                    <p class="text-2xl font-semibold text-gray-900" id="error-rate">--</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Document Types Distribution -->
        <div class="bg-white  shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Document Types Distribution</h3>
                <button onclick="refreshDocumentTypesChart()" class="text-blue-600 hover:text-blue-800 text-sm">
                    <i class="fas fa-refresh mr-1"></i>Refresh
                </button>
            </div>
            <div class="relative h-64">
                <canvas id="documentTypesChart"></canvas>
            </div>
        </div>

        <!-- Criticality Levels -->
        <div class="bg-white  shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">Criticality Levels</h3>
                <button onclick="refreshCriticalityChart()" class="text-blue-600 hover:text-blue-800 text-sm">
                    <i class="fas fa-refresh mr-1"></i>Refresh
                </button>
            </div>
            <div class="relative h-64">
                <canvas id="criticalityChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Processing Trends -->
    <div class="bg-white  shadow-sm border border-gray-200 p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-semibold text-gray-900">Processing Trends (Last 30 Days)</h3>
            <button onclick="refreshTrendsChart()" class="text-blue-600 hover:text-blue-800 text-sm">
                <i class="fas fa-refresh mr-1"></i>Refresh
            </button>
        </div>
        <div class="relative h-80">
            <canvas id="trendsChart"></canvas>
        </div>
    </div>

    <!-- Additional Analytics -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- File Types Distribution -->
        <div class="bg-white  shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-lg font-semibold text-gray-900">File Types Distribution</h3>
                <button onclick="refreshFileTypesChart()" class="text-blue-600 hover:text-blue-800 text-sm">
                    <i class="fas fa-refresh mr-1"></i>Refresh
                </button>
            </div>
            <div class="relative h-64">
                <canvas id="fileTypesChart"></canvas>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="bg-white  shadow-sm border border-gray-200 p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-6">Performance Metrics</h3>
            <div class="space-y-4">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-600">Success Rate</span>
                    <span class="text-lg font-semibold text-green-600" id="success-rate">--</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-600">Total Categories</span>
                    <span class="text-lg font-semibold text-blue-600" id="total-categories">--</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-600">FileNet Uploads</span>
                    <span class="text-lg font-semibold text-purple-600" id="filenet-uploads">--</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-600">Last 24h Documents</span>
                    <span class="text-lg font-semibold text-orange-600" id="last-24h-docs">--</span>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_scripts %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Chart instances
let documentTypesChart, criticalityChart, trendsChart, fileTypesChart;

// Color palettes
const colors = {
    primary: ['#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6', '#06B6D4'],
    criticality: {
        'Public': '#10B981',
        'Confidential': '#F59E0B', 
        'Restricted': '#EF4444',
        'Classified': '#6B7280',
        'Top Secret': '#3B82F6'
    }
};

// Load analytics data
function loadAnalyticsData() {
    fetch('/api/analytics')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error loading analytics:', data.error);
                return;
            }
            
            updateKPICards(data);
            updateCharts(data);
        })
        .catch(error => {
            console.error('Error loading analytics data:', error);
        });
}

// Update KPI cards
function updateKPICards(data) {
    document.getElementById('total-documents').textContent = data.total_documents || 0;
    document.getElementById('processed-today').textContent = data.processed_today || 0;
    document.getElementById('avg-processing-time').textContent = (data.avg_processing_time || 0) + 's';
    document.getElementById('error-rate').textContent = (data.error_rate || 0) + '%';
    document.getElementById('success-rate').textContent = (data.success_rate || 0) + '%';
    document.getElementById('total-categories').textContent = data.total_categories || 0;
    document.getElementById('filenet-uploads').textContent = data.filenet_uploads || 0;
    document.getElementById('last-24h-docs').textContent = data.processed_today || 0;
}

// Update all charts
function updateCharts(data) {
    updateDocumentTypesChart(data.document_types || []);
    updateCriticalityChart(data.criticality_levels || []);
    updateTrendsChart(data.processing_trends || []);
    updateFileTypesChart(data.file_types || []);
}

// Document Types Donut Chart
function updateDocumentTypesChart(documentTypes) {
    const ctx = document.getElementById('documentTypesChart').getContext('2d');
    
    if (documentTypesChart) {
        documentTypesChart.destroy();
    }
    
    const labels = documentTypes.map(item => item.name);
    const values = documentTypes.map(item => item.count);
    
    documentTypesChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: colors.primary.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                }
            }
        }
    });
}

// Criticality Levels Bar Chart
function updateCriticalityChart(criticalityLevels) {
    const ctx = document.getElementById('criticalityChart').getContext('2d');
    
    if (criticalityChart) {
        criticalityChart.destroy();
    }
    
    const labels = criticalityLevels.map(item => item.name);
    const values = criticalityLevels.map(item => item.count);
    const backgroundColors = labels.map(label => colors.criticality[label] || '#6B7280');
    
    criticalityChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Documents',
                data: values,
                backgroundColor: backgroundColors,
                borderColor: backgroundColors,
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

// Processing Trends Line Chart
function updateTrendsChart(processingTrends) {
    const ctx = document.getElementById('trendsChart').getContext('2d');
    
    if (trendsChart) {
        trendsChart.destroy();
    }
    
    const labels = processingTrends.map(item => {
        const date = new Date(item.date);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    });
    const values = processingTrends.map(item => item.count);
    
    trendsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Documents Processed',
                data: values,
                borderColor: '#3B82F6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                }
            }
        }
    });
}

// File Types Chart
function updateFileTypesChart(fileTypes) {
    const ctx = document.getElementById('fileTypesChart').getContext('2d');
    
    if (fileTypesChart) {
        fileTypesChart.destroy();
    }
    
    const labels = fileTypes.map(item => item.name || 'Unknown');
    const values = fileTypes.map(item => item.count);
    
    fileTypesChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: colors.primary.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                }
            }
        }
    });
}

// Refresh functions
function refreshDocumentTypesChart() {
    loadAnalyticsData();
}

function refreshCriticalityChart() {
    loadAnalyticsData();
}

function refreshTrendsChart() {
    loadAnalyticsData();
}

function refreshFileTypesChart() {
    loadAnalyticsData();
}

// Export functions
function exportAnalytics() {
    // Show loading state
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating PDF...';
    button.disabled = true;
    
    // Fetch analytics data and generate PDF
    fetch('/api/export/analytics/pdf')
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to generate PDF');
            }
            return response.blob();
        })
        .then(blob => {
            // Create object URL for the PDF
            const url = window.URL.createObjectURL(blob);
            
            // Open PDF in new tab
            const newWindow = window.open(url, '_blank');
            if (!newWindow) {
                // Fallback: download the file
                const a = document.createElement('a');
                a.href = url;
                a.download = `analytics_report_${new Date().toISOString().split('T')[0]}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            }
            
            // Clean up object URL
            setTimeout(() => window.URL.revokeObjectURL(url), 1000);
        })
        .catch(error => {
            console.error('Error exporting analytics:', error);
            alert('Failed to generate PDF. Please try again.');
        })
        .finally(() => {
            // Restore button state
            button.innerHTML = originalText;
            button.disabled = false;
        });
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadAnalyticsData();
    
    // Refresh data every 60 seconds
    setInterval(loadAnalyticsData, 60000);
});
</script>
{% endblock %}
