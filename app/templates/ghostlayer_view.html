{% extends "base.html" %}

{% block title %}GhostLayer AI - IDMS{% endblock %}

{% block page_title %}GhostLayer AI{% endblock %}
{% block page_subtitle %}Advanced AI Document Processing and Analysis{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Breadcrumb Navigation -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="py-4">
                <nav class="flex" aria-label="Breadcrumb">
                    <ol class="flex items-center space-x-4">
                        <li>
                            <div>
                                <a href="/ghostlayer-ai" class="text-gray-400 hover:text-gray-500">
                                    <i class="fas fa-robot mr-2"></i>
                                    <span class="sr-only">GhostLayer AI</span>
                                </a>
                            </div>
                        </li>
                        <li>
                            <div class="flex items-center">
                                <i class="fas fa-chevron-right text-gray-400 mr-4"></i>
                                <span class="text-sm font-medium text-gray-500">Document Viewer</span>
                            </div>
                        </li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Image Viewer with Tabs -->
        <div class="bg-white  shadow-sm border">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900">Document Viewer</h2>
                        <div class="mt-2 flex items-center space-x-6 text-sm text-gray-600">
                            <div>
                                <span class="font-medium">Document:</span> <span id="viewer-document-name">-</span>
                            </div>
                            <div>
                                <span class="font-medium">Uploaded:</span> <span id="viewer-upload-date">-</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <label class="text-sm font-medium text-gray-700">Zoom:</label>
                            <select id="zoom-level" class="text-sm border-gray-300  focus:ring-purple-500 focus:border-purple-500">
                                <option value="0.5">50%</option>
                                <option value="0.75">75%</option>
                                <option value="1" selected>100%</option>
                                <option value="1.25">125%</option>
                                <option value="1.5">150%</option>
                                <option value="2">200%</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Tab Navigation -->
                <div class="mt-4">
                    <nav class="flex space-x-8" aria-label="Tabs">
                        <button id="tab-original" onclick="switchTab('original')" 
                                class="tab-button active py-2 px-1 border-b-2 border-purple-500 font-medium text-sm text-purple-600">
                            <i class="fas fa-image mr-2"></i>
                            Original Image
                        </button>
                        <button id="tab-marked" onclick="switchTab('marked')" 
                                class="tab-button py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            <i class="fas fa-mask mr-2"></i>
                            Redacted Image
                        </button>
                    </nav>
                </div>
            </div>
            
            <div class="p-6">
                <!-- Loading State -->
                <div id="loading-state" class="flex items-center justify-center py-12">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin text-4xl text-purple-600 mb-4"></i>
                        <p class="text-gray-600">Loading document...</p>
                    </div>
                </div>
                
                <!-- Error State -->
                <div id="error-state" class="hidden flex items-center justify-center py-12">
                    <div class="text-center">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                        <p class="text-gray-600" id="error-message">Failed to load document</p>
                        <button onclick="loadDocument()" class="mt-4 px-4 py-2 bg-purple-600 text-white  hover:bg-purple-700 transition-colors duration-200">
                            Retry
                        </button>
                    </div>
                </div>
                
                <!-- Tab Content -->
                <div id="tab-content">
                    <!-- Original Image Tab -->
                    <div id="tab-original-content" class="tab-content">
                        <div class="border border-gray-200  overflow-hidden bg-gray-50">
                            <img id="original-image" src="" alt="Original Document" class="w-full h-auto">
                        </div>
                        <div class="mt-4 p-4 bg-blue-50 ">
                            <h3 class="text-sm font-medium text-blue-900 mb-2">
                                <i class="fas fa-info-circle mr-2"></i>
                                Original Document
                            </h3>
                            <p class="text-xs text-blue-700">This is the original uploaded document without any modifications.</p>
                        </div>
                    </div>
                    
                    <!-- Marked Image Tab -->
                    <div id="tab-marked-content" class="tab-content hidden">
                        <div class="border border-gray-200  overflow-hidden bg-gray-50">
                            <img id="marked-image" src="" alt="Document with coordinates" class="w-full h-auto">
                        </div>
                        
                        <!-- Masking Legend -->
                        <div class="mt-4 p-4 bg-gray-50 ">
                            <h3 class="text-sm font-medium text-gray-900 mb-2">
                                <i class="fas fa-mask mr-2"></i>
                                Black Mask Redaction
                            </h3>
                            <div class="flex flex-wrap gap-4 text-xs">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-black  mr-2"></div>
                                    <span>Text Blocks (Masked)</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-black  mr-2"></div>
                                    <span>Paragraphs (Masked)</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-black  mr-2"></div>
                                    <span>Individual Tokens (Masked)</span>
                                </div>
                            </div>
                            <p class="text-xs text-gray-600 mt-2">
                                <i class="fas fa-info-circle mr-1"></i>
                                All detected text areas are masked with black rectangles for privacy protection.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let documentId = null;
let documentData = null;

// Get document ID from URL parameters
function getDocumentId() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('id');
}

// Load document data
async function loadDocument() {
    documentId = getDocumentId();
    if (!documentId) {
        showError('Document ID not found');
        return;
    }
    
    try {
        showLoading();
        
        // Fetch document data
        const response = await fetch(`/api/ghostlayer/documents/${documentId}`);
        if (!response.ok) {
            throw new Error('Failed to load document data');
        }
        
        documentData = await response.json();
        updateDocumentInfo();
        
        // Load both images
        await loadImages();
        
    } catch (error) {
        console.error('Error loading document:', error);
        showError('Failed to load document: ' + error.message);
    }
}

// Update document information
function updateDocumentInfo() {
    if (!documentData) return;
    
    // Update the Document Viewer card fields
    document.getElementById('viewer-document-name').textContent = documentData.document_name;
    document.getElementById('viewer-upload-date').textContent = new Date(documentData.upload_timestamp).toLocaleDateString();
}

// Load both original and marked images
async function loadImages() {
    try {
        // Load original image
        await loadOriginalImage();
        
        // Load marked image
        await loadMarkedImage();
        
        // Setup zoom functionality
        setupZoom();
        
        hideLoading();
        showImage();
        
    } catch (error) {
        console.error('Error loading images:', error);
        showError('Failed to load images: ' + error.message);
    }
}

// Load original image
async function loadOriginalImage() {
    try {
        const response = await fetch(`/api/ghostlayer/download/${documentId}`);
        if (!response.ok) {
            throw new Error('Failed to load original image');
        }
        
        const blob = await response.blob();
        const imageUrl = URL.createObjectURL(blob);
        
        const img = document.getElementById('original-image');
        img.src = imageUrl;
        
    } catch (error) {
        console.error('Error loading original image:', error);
        throw error;
    }
}

// Load marked image with coordinates
async function loadMarkedImage() {
    try {
        const response = await fetch(`/api/ghostlayer/view/${documentId}`);
        if (!response.ok) {
            throw new Error('Failed to load marked image');
        }
        
        const blob = await response.blob();
        const imageUrl = URL.createObjectURL(blob);
        
        const img = document.getElementById('marked-image');
        img.src = imageUrl;
        
    } catch (error) {
        console.error('Error loading marked image:', error);
        throw error;
    }
}

// Setup zoom functionality
function setupZoom() {
    const zoomSelect = document.getElementById('zoom-level');
    const originalImage = document.getElementById('original-image');
    const markedImage = document.getElementById('marked-image');
    
    zoomSelect.addEventListener('change', function() {
        const zoom = parseFloat(this.value);
        originalImage.style.transform = `scale(${zoom})`;
        originalImage.style.transformOrigin = 'top left';
        markedImage.style.transform = `scale(${zoom})`;
        markedImage.style.transformOrigin = 'top left';
    });
}

// Tab switching functionality
function switchTab(tabName) {
    // Update tab buttons
    const originalTab = document.getElementById('tab-original');
    const markedTab = document.getElementById('tab-marked');
    
    // Update tab content visibility
    const originalContent = document.getElementById('tab-original-content');
    const markedContent = document.getElementById('tab-marked-content');
    
    if (tabName === 'original') {
        // Show original tab
        originalTab.classList.add('active', 'border-purple-500', 'text-purple-600');
        originalTab.classList.remove('border-transparent', 'text-gray-500');
        markedTab.classList.remove('active', 'border-purple-500', 'text-purple-600');
        markedTab.classList.add('border-transparent', 'text-gray-500');
        
        // Show original content
        originalContent.classList.remove('hidden');
        markedContent.classList.add('hidden');
        
    } else if (tabName === 'marked') {
        // Show marked tab
        markedTab.classList.add('active', 'border-purple-500', 'text-purple-600');
        markedTab.classList.remove('border-transparent', 'text-gray-500');
        originalTab.classList.remove('active', 'border-purple-500', 'text-purple-600');
        originalTab.classList.add('border-transparent', 'text-gray-500');
        
        // Show marked content
        markedContent.classList.remove('hidden');
        originalContent.classList.add('hidden');
    }
}

// Show loading state
function showLoading() {
    document.getElementById('loading-state').classList.remove('hidden');
    document.getElementById('error-state').classList.add('hidden');
    document.getElementById('tab-content').classList.add('hidden');
}

// Hide loading state
function hideLoading() {
    document.getElementById('loading-state').classList.add('hidden');
}

// Show error state
function showError(message) {
    document.getElementById('error-message').textContent = message;
    document.getElementById('error-state').classList.remove('hidden');
    document.getElementById('loading-state').classList.add('hidden');
    document.getElementById('tab-content').classList.add('hidden');
}

// Show image
function showImage() {
    document.getElementById('tab-content').classList.remove('hidden');
}


// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadDocument();
});
</script>
{% endblock %}
